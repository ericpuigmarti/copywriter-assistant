<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copywriter Assistant</title>
    <style>
        /* Theme variables */
        :root[data-theme="light"] {
            --background-color: #FFFFFF;
            --surface-color: #F8F8F8;
            --text-color: #1A1A1A;
            --secondary-text: #666666;
            --border-color: #E5E5E5;
            --button-bg: #F5F5F5;
            --button-hover: #EEEEEE;
            --input-bg: #FFFFFF;
            --header-bg: #FFFFFF;
            --modal-bg: #FFFFFF;
            --divider-color: #E5E5E5;
            --icon-color: #666666;
            --accent-color: #5E5EFF;
            --accent-hover: #4B4BFF;
            --success-color: #4CAF50;
            --primary-button: #0051FE;
            --primary-button-hover: #0045DB;
            --primary-text: #FFFFFF;
            --border-subtle: #e4e4e7;
        }

        :root[data-theme="dark"] {
            --background-color: #141414;
            --surface-color: #1E1E1E;
            --text-color: #FFFFFF;
            --secondary-text: #8C8C8C;
            --border-color: #2C2C2C;
            --button-bg: #242424;
            --button-hover: #2C2C2C;
            --input-bg: #1E1E1E;
            --header-bg: #141414;
            --modal-bg: #141414;
            --divider-color: #2C2C2C;
            --icon-color: #8C8C8C;
            --accent-color: #7B7BFF;
            --accent-hover: #8E8EFF;
            --success-color: #66BB6A;
            --primary-button: #0051FE;
            --primary-button-hover: #1A65FE;
            --primary-text: #FFFFFF;
            --border-subtle: #27272a;
        }

        /* Remove the media query and add this for system preference */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --background-color: #141414;
                --surface-color: #1E1E1E;
                --text-color: #FFFFFF;
                --secondary-text: #8C8C8C;
                --border-color: #2C2C2C;
                --button-bg: #242424;
                --button-hover: #2C2C2C;
                --input-bg: #1E1E1E;
                --header-bg: #141414;
                --modal-bg: #141414;
                --divider-color: #2C2C2C;
                --icon-color: #8C8C8C;
                --accent-color: #7B7BFF;
                --accent-hover: #8E8EFF;
                --success-color: #66BB6A;
            }
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Use system fonts with Inter-like alternatives */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            width: 400px;
            height: 600px;
            overflow: hidden;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Layout */
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Typography */
        h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Components */
        .textarea {
            width: 100%;
            height: 8rem;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 0.875rem;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .action-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        /* Update button styles */
        .action-btn {
            width: 100%;
            padding: 12px 16px;
            border: none; /* Remove border */
            border-radius: 8px;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 200ms ease;
            outline: none;
        }

        .action-btn:focus {
            outline: none;
        }

        .action-btn:focus-visible {
            outline: none;
        }

        .btn-content {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            border: none; /* Ensure no border */
        }

        .btn-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: none; /* Ensure no border */
        }

        .btn-title {
            font-size: 14px;
            font-weight: 500;
            color: #0E0D10;
        }

        .btn-description {
            font-size: 12px;
            color: #71717A;
        }

        .btn-icon {
            width: 16px;
            height: 16px;
            color: #71717A;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none; /* Remove any potential border from icon containers */
        }

        .btn-icon svg {
            width: 16px !important;
            height: 16px !important;
            stroke: currentColor;
            stroke-width: 1.5;
            flex-shrink: 0;
        }

        .chevron {
            width: 16px;
            height: 16px;
            color: #71717A;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none; /* Remove any potential border from icon containers */
        }

        .chevron svg {
            width: 16px !important;
            height: 16px !important;
            stroke: currentColor;
            stroke-width: 1.5;
            flex-shrink: 0;
        }

        .loading {
            text-align: center;
            color: #6b7280;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            margin-top: 1rem;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            z-index: 1000;
        }

        .modal.visible {
            display: block;
        }

        .modal-content {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--modal-bg);
            color: var(--text-color);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header .back-button {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .modal-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .setting-item {
            padding: 12px 16px;
            border-radius: 8px;
            background-color: var(--surface-color);
            margin-bottom: 8px;
        }

        .setting-item:hover {
            background-color: var(--button-hover);
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .setting-item label svg {
            width: 16px;
            height: 16px;
            color: var(--icon-color);
        }

        .setting-item select {
            width: 100%;
            padding: 16px;
            border: 1px solid #71717A;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        .setting-item select:hover {
            background-color: var(--button-hover);
        }

        .setting-item select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .text-button {
            background-color: var(--button-bg);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Add subtle shadow */
        }

        .text-button:hover {
            background-color: var(--button-hover);
        }

        .close-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
        }

        .close-button:hover {
            color: var(--accent-color);
        }

        .close-button svg {
            width: 16px;
            height: 16px;
        }

        /* Results View */
        #resultsView {
            margin-top: 1rem;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: none;
            background: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .btn-icon:hover {
            color: var(--accent-color);
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 16px 0;
        }

        .results-column {
            width: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
        }

        .results-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--button-bg);
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .results-content {
            padding: 16px;
            flex-grow: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .results-content p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .results-divider {
            display: flex;
            justify-content: center;
            color: var(--secondary-text);
            height: 24px;
        }

        .original {
            background-color: var(--input-bg);
            color: var(--secondary-text);
        }

        .processed {
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .results-actions {
            display: flex;
            justify-content: flex-end;
            padding: 16px 0 0;
            margin-top: 16px;
        }

        /* Add smooth transitions */
        .results-content, .results-header {
            transition: background-color 0.2s ease;
        }

        /* Hover effects */
        .results-column:hover {
            border-color: var(--button-hover);
        }

        .guidelines-textarea {
            height: 120px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .setting-help {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
        }

        /* Change indicator styles */
        .change-indicator {
            display: none;
        }

        .change-type {
            display: none;
        }

        .highlight-add {
            display: none;
        }

        .highlight-remove {
            display: none;
        }

        .highlight-modify {
            display: none;
        }

        .save-confirmation {
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            color: #10B981; /* Success green */
            font-size: 14px;
        }

        .save-confirmation.visible {
            display: flex;
        }

        .save-confirmation svg {
            stroke: #10B981;
        }

        /* Update primary button styles */
        .action-btn.primary {
            background-color: #3B82F6;  /* Updated blue color */
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            width: auto;  /* Override full width */
            transition: background-color 200ms ease;
        }

        .action-btn.primary:hover {
            background-color: #2563EB;  /* Darker blue on hover */
        }

        .action-btn.primary svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Section title styles */
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 16px 0 8px 0;
        }

        .quality-report {
            padding: 24px;
            background: var(--surface-color);
            border-radius: 12px;
        }

        .score-summary {
            text-align: center;
            margin-bottom: 32px;
        }

        .score-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--surface-color);
            border: 4px solid;
        }

        .score-circle[data-score="85"] {
            border-color: #4CAF50;
        }

        .score-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
            color: var(--text-color);
        }

        .score-total {
            font-size: 16px;
            color: var(--secondary-text);
        }

        .score-badge {
            padding: 6px 12px;
            border-radius: 16px;
            background: #4CAF50;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        .criteria-section {
            margin: 32px 0;
        }

        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 16px;
        }

        .criteria-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            height: 8px;
            background: var(--button-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-button);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .analysis-section {
            display: grid;
            gap: 24px;
            margin: 32px 0;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .analysis-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Settings Modal Styles */
        .settings-modal {
            padding: 24px;
            background: var(--background-color);
            height: 100%;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .back-button {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            border-radius: 6px;
        }

        .back-button:hover {
            background: var(--button-hover);
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        /* Update Dropdown Select Styles */
        .settings-select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: transparent; /* Remove background */
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 20px;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        .settings-select:hover {
            background-color: var(--button-hover);
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Remove background from select options */
        .settings-select option {
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Update Brand Guidelines Textarea */
        .settings-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: transparent;  /* Remove background */
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }

        .settings-textarea:hover {
            background-color: var(--button-hover);
        }

        .settings-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            background: transparent;  /* Keep transparent on focus */
        }

        /* Brand Guidelines Textarea */
        .brand-guidelines {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
        }

        .brand-guidelines h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .brand-guidelines h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            margin: 12px 0 4px;
        }

        .brand-guidelines p {
            font-size: 13px;
            line-height: 1.4;
            color: var(--secondary-text);
            margin-bottom: 8px;
        }

        .brand-guidelines ul {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .brand-guidelines li {
            font-size: 13px;
            line-height: 1.4;
            color: var(--secondary-text);
            margin-bottom: 4px;
            padding-left: 8px;
        }

        .brand-guidelines li::before {
            content: "â€¢";
            color: var(--secondary-text);
            display: inline-block;
            width: 8px;
            margin-left: -8px;
        }

        /* Add hover effect without border */
        .action-btn:hover {
            background-color: #F4F4F5;
        }

        /* Update settings button container styles */
        .settings-button-container {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 100;
            transition: opacity 200ms ease;
        }

        .settings-button-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <main>
            <textarea id="textEditor" class="textarea" placeholder="Select text in Figma or type here..."></textarea>
            <div class="section-title">Writing tools</div>
            <div class="action-panel">
                <button id="translateButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Translate</div>
                            <div class="btn-description">Convert text to different languages</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
                <button id="enhanceButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Enhance</div>
                            <div class="btn-description">Improve writing quality and clarity</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
                <button id="shortenButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="6" cy="6" r="3"></circle>
                                <circle cx="6" cy="18" r="3"></circle>
                                <line x1="20" y1="4" x2="8.12" y2="15.88"></line>
                                <line x1="14.47" y1="14.48" x2="20" y2="20"></line>
                                <line x1="8.12" y1="8.12" x2="12" y2="12"></line>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Shorten</div>
                            <div class="btn-description">Create a concise version of your text</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
            </div>
            <div id="loadingIndicator" class="loading" style="display: none;">
                Processing...
            </div>
            <div id="resultsView" style="display: none;">
                <button id="backToEdit" class="btn-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Edit
                </button>
                <div class="results-container">
                    <div class="results-column">
                        <div class="results-header">
                            <h3>Original Text</h3>
                        </div>
                        <div class="results-content original">
                            <p id="originalText"></p>
                        </div>
                    </div>
                    <div class="results-divider">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="7 13 12 18 17 13"></polyline>
                            <polyline points="7 6 12 11 17 6"></polyline>
                        </svg>
                    </div>
                    <div class="results-column">
                        <div class="results-header">
                            <h3>Processed Text</h3>
                        </div>
                        <div class="results-content processed">
                            <p id="processedText"></p>
                        </div>
                    </div>
                </div>
                <div class="results-actions">
                    <button id="applyToFigma" class="action-btn primary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                            <path d="M13.3332 4L5.99984 11.3333L2.6665 8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Apply to Figma
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Add settings button container -->
        <div class="settings-button-container">
            <button id="settingsButton" class="text-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Settings
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal settings-modal">
        <div class="settings-header">
            <button class="back-button" id="closeSettings">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2 class="settings-title">Settings & Preferences</h2>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title">Language</h3>
            <select id="targetLanguageSelect" class="settings-select">
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="fr-ca">French (Canada)</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="nl">Dutch</option>
                <option value="pl">Polish</option>
                <option value="ru">Russian</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="zh">Chinese (Simplified)</option>
            </select>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title">Brand Guidelines</h3>
            <textarea id="brandGuidelinesInput" class="settings-textarea" placeholder="Enter your brand guidelines here..."></textarea>
            <div id="saveConfirmation" class="save-confirmation">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                    <path d="M3 8l3.5 3.5L13 4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Changes saved</span>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title">Appearance</h3>
            <select id="themeSelect" class="settings-select">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="system">System</option>
            </select>
        </div>
    </div>

    <script>
        // UI Elements
        const textEditor = document.getElementById('textEditor');
        const translateButton = document.getElementById('translateButton');
        const enhanceButton = document.getElementById('enhanceButton');
        const shortenButton = document.getElementById('shortenButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeButton = document.getElementById('closeSettings');
        const targetLanguageSelect = document.getElementById('targetLanguageSelect');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsView = document.getElementById('resultsView');
        const backToEditButton = document.getElementById('backToEdit');
        const applyToFigmaButton = document.getElementById('applyToFigma');
        const themeSelect = document.getElementById('themeSelect');
        let currentProcessedTexts = [];
        let selectedTexts = new Map();

        // Helper function to toggle views
        function showResults() {
            textEditor.style.display = 'none';
            document.querySelector('.action-panel').style.display = 'none';
            document.querySelector('.section-title').style.display = 'none';
            document.querySelector('.settings-button-container').classList.add('hidden');
            resultsView.style.display = 'block';
        }

        function showEditor() {
            textEditor.style.display = 'block';
            document.querySelector('.action-panel').style.display = 'flex';
            document.querySelector('.section-title').style.display = 'block';
            document.querySelector('.settings-button-container').classList.remove('hidden');
            resultsView.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }

        // Update the back button handler
        backToEditButton.addEventListener('click', () => {
            showEditor();
        });

        // Update API call handlers
        async function handleAPICall(endpoint, data) {
            loadingIndicator.style.display = 'block';
            resultsView.style.display = 'none';
            textEditor.style.display = 'none';
            document.querySelector('.action-panel').style.display = 'none';
            document.querySelector('.section-title').style.display = 'none';
            
            try {
                const response = await callAPI(endpoint, data);
                document.getElementById('originalText').textContent = textEditor.value;
                
                // Set the processed text based on the endpoint
                const processedText = response.translatedText || response.enhancedText || response.shortenedText;
                document.getElementById('processedText').textContent = processedText;
                
                currentProcessedTexts = Array.from(selectedTexts.keys()).map(id => ({
                    id: id,
                    text: processedText
                }));
                
                loadingIndicator.style.display = 'none';
                showResults();
            } catch (error) {
                loadingIndicator.style.display = 'none';
                showEditor();
                alert(`${endpoint} failed. Please try again. ` + error.message);
            }
        }

        // Update button handlers to use the new handleAPICall function
        translateButton.addEventListener('click', async () => {
            if (!textEditor.value.trim()) return;
            await handleAPICall('translate', {
                text: textEditor.value,
                targetLanguage: targetLanguageSelect.value
            });
        });

        enhanceButton.addEventListener('click', async () => {
            if (!textEditor.value.trim()) return;
            await handleAPICall('enhance', {
                text: textEditor.value
            });
        });

        shortenButton.addEventListener('click', async () => {
            if (!textEditor.value.trim()) return;
            await handleAPICall('shorten', {
                text: textEditor.value
            });
        });

        // Helper function for API calls
        async function callAPI(endpoint, data) {
            try {
                const response = await fetch(`http://localhost:5000/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'omit',
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`${endpoint} error:`, error);
                throw error;
            }
        }

        // Update the message handler to trigger button state update
        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            switch (msg.type) {
                case 'selected-text':
                    console.log('Received selected texts:', msg.texts);
                    selectedTexts.clear();
                    let combinedText = '';
                    
                    if (msg.texts && msg.texts.length > 0) {
                        msg.texts.forEach(item => {
                            selectedTexts.set(item.id, item.text);
                            combinedText += item.text + '\n\n';
                        });
                        
                        textEditor.value = combinedText.trim();
                        updateButtonStates(); // Update button states when text is received
                    } else {
                        textEditor.value = '';
                        updateButtonStates(); // Update button states when text is cleared
                    }
                    break;

                case 'set-brand-guidelines':
                    console.log('Received saved guidelines:', msg.guidelines);
                    if (msg.guidelines) {
                        brandGuidelinesInput.value = msg.guidelines;
                    }
                    break;

                case 'set-language':
                    // ... existing language handling ...
                    break;
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            
            // Request initial data
            parent.postMessage({ pluginMessage: { type: 'get-selected-text' } }, '*');
            parent.postMessage({ pluginMessage: { type: 'get-language' } }, '*');
            parent.postMessage({ pluginMessage: { type: 'get-brand-guidelines' } }, '*');
        });

        // Keep helper functions outside
        function setTheme(theme) {
            // ... theme setting code ...
        }

        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', 'light');
            if (themeSelect) {
                themeSelect.value = 'light';
            }
        }

        // Function to update button states
        function updateButtonStates() {
            const hasText = textEditor.value.trim().length > 0;
            translateButton.disabled = !hasText;
            enhanceButton.disabled = !hasText;
            shortenButton.disabled = !hasText;
        }

        // Add textarea event listeners
        textEditor.addEventListener('input', updateButtonStates);
        textEditor.addEventListener('change', updateButtonStates);

        // Settings modal functionality
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('visible');
        });

        closeButton.addEventListener('click', () => {
            settingsModal.classList.remove('visible');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('visible');
            }
        });

        // Brand guidelines save functionality
        const brandGuidelinesInput = document.getElementById('brandGuidelinesInput');
        const saveConfirmation = document.getElementById('saveConfirmation');

        let saveTimeout;

        brandGuidelinesInput.addEventListener('input', () => {
            // Clear any existing timeout
            clearTimeout(saveTimeout);
            
            // Set new timeout to save after user stops typing
            saveTimeout = setTimeout(async () => {
                try {
                    // Send to parent (Figma)
                    parent.postMessage({ 
                        pluginMessage: { 
                            type: 'save-brand-guidelines',
                            guidelines: brandGuidelinesInput.value 
                        }
                    }, '*');
                    
                    // Show save confirmation
                    saveConfirmation.classList.add('visible');
                    
                    // Hide confirmation after 2 seconds
                    setTimeout(() => {
                        saveConfirmation.classList.remove('visible');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error saving guidelines:', error);
                }
            }, 500); // Wait 500ms after last keystroke before saving
        });

        // Add apply to Figma handler
        applyToFigmaButton.addEventListener('click', () => {
            // Send processed texts back to Figma
            parent.postMessage({
                pluginMessage: {
                    type: 'apply-text',
                    texts: currentProcessedTexts
                }
            }, '*');
            
            // Return to editor view
            showEditor();
        });
    </script>
</body>
</html>