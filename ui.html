<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CopyMate - Smarter, Faster, Better Copywriting</title>
    <style>
        /* Add Inter font import at the top of the CSS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        /* Theme variables */
        :root[data-theme="light"] {
            --background-color: #FFFFFF;
            --surface-color: #F8F8F8;
            --text-color: #1A1A1A;
            --secondary-text: #666666;
            --border-color: #E5E5E5;
            --button-bg: #F5F5F5;
            --button-hover: #EEEEEE;
            --input-bg: #FFFFFF;
            --header-bg: #FFFFFF;
            --modal-bg: #FFFFFF;
            --divider-color: #E5E5E5;
            --icon-color: #666666;
            --accent-color: #5E5EFF;
            --accent-hover: #4B4BFF;
            --success-color: #4CAF50;
            --primary-button: #0051FE;
            --primary-button-hover: #0045DB;
            --primary-text: #FFFFFF;
            --border-subtle: #e4e4e7;
        }

        :root[data-theme="dark"] {
            --background-color: #141414;
            --surface-color: #1E1E1E;
            --text-color: #FFFFFF;
            --secondary-text: #8C8C8C;
            --border-color: #2C2C2C;
            --button-bg: #242424;
            --button-hover: #2C2C2C;
            --input-bg: #1E1E1E;
            --header-bg: #141414;
            --modal-bg: #141414;
            --divider-color: #2C2C2C;
            --icon-color: #8C8C8C;
            --accent-color: #7B7BFF;
            --accent-hover: #8E8EFF;
            --success-color: #66BB6A;
            --primary-button: #0051FE;
            --primary-button-hover: #1A65FE;
            --primary-text: #FFFFFF;
            --border-subtle: #27272a;
        }

        /* Remove the media query and add this for system preference */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --background-color: #141414;
                --surface-color: #1E1E1E;
                --text-color: #FFFFFF;
                --secondary-text: #8C8C8C;
                --border-color: #2C2C2C;
                --button-bg: #242424;
                --button-hover: #2C2C2C;
                --input-bg: #1E1E1E;
                --header-bg: #141414;
                --modal-bg: #141414;
                --divider-color: #2C2C2C;
                --icon-color: #8C8C8C;
                --accent-color: #7B7BFF;
                --accent-hover: #8E8EFF;
                --success-color: #66BB6A;
            }
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 400px;
            height: 600px;
            overflow: visible;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            border-radius: 8px;
        }

        /* Ensure consistent font rendering */
        * {
            text-rendering: optimizeLegibility;
        }

        /* Layout */
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            border-radius: 8px; /* Add border radius */
            overflow: visible; /* Change from hidden to visible */
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 72px; /* Add padding to prevent content from being hidden behind footer */
            border-radius: 8px; /* Add border radius */
        }

        /* Typography */
        h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Components */
        .textarea {
            width: 100%;
            height: 8rem;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 0.875rem;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .action-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        /* Update button styles */
        .action-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            background-color: var(--surface-color);  /* Add subtle background */
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 200ms ease;
            outline: none;
        }

        .action-btn:focus {
            outline: none;
        }

        .action-btn:focus-visible {
            outline: none;
        }

        .btn-content {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            border: none; /* Ensure no border */
        }

        .btn-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: none; /* Ensure no border */
        }

        .btn-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .btn-description {
            font-size: 13px;
            font-weight: 400;
            color: var(--secondary-text);
            letter-spacing: 0.04em;
        }

        .btn-icon {
            width: 16px;
            height: 16px;
            color: var(--secondary-text);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .btn-icon svg {
            width: 16px !important;
            height: 16px !important;
            stroke: currentColor;
            stroke-width: 1.5;
            flex-shrink: 0;
        }

        .chevron {
            width: 16px;
            height: 16px;
            color: var(--secondary-text);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .chevron svg {
            width: 16px !important;
            height: 16px !important;
            stroke: currentColor;
            stroke-width: 1.5;
            flex-shrink: 0;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--secondary-text);
            font-size: 14px;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            z-index: 1000;
        }

        .modal.visible {
            display: block;
        }

        .modal-content {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--modal-bg);
            color: var(--text-color);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header .back-button {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .modal-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        /* Settings */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
            line-height: 1.4;
        }

        .setting-item {
            padding: 12px 16px;
            border-radius: 8px;
            background-color: var(--surface-color);
            margin-bottom: 8px;
        }

        .setting-item:hover {
            background-color: var(--button-hover);
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .setting-item label svg {
            width: 16px;
            height: 16px;
            color: var(--icon-color);
        }

        .setting-item select {
            width: 100%;
            padding: 16px;
            border: 1px solid #71717A;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: var(--text-color);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        .setting-item select:hover {
            background-color: var(--button-hover);
        }

        .setting-item select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .text-button {
            background-color: var(--button-bg);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            /* Remove the box-shadow that might be causing the issue */
            box-shadow: none;
        }

        .text-button:hover {
            background-color: var(--button-hover);
        }

        .close-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
        }

        .close-button:hover {
            color: var(--accent-color);
        }

        .close-button svg {
            width: 16px;
            height: 16px;
        }

        /* Results View */
        #resultsView {
            padding: 16px;
        }

        .results-header {
            margin-bottom: 16px;  /* Add space between header and container */
        }

        .results-container {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
        }

        .results-column {
            background: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .results-column-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .results-column-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .results-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
        }

        .results-content.original {
            color: var(--secondary-text);
            text-decoration: line-through;  /* Add strikethrough */
            text-decoration-color: var(--secondary-text);  /* Match text color */
            text-decoration-thickness: 1px;  /* Thin line */
            opacity: 0.8;  /* Slightly faded */
        }

        .results-content.processed {
            background: var(--surface-color);
        }

        .results-actions {
            display: flex;
            justify-content: flex-end;
            padding: 16px 0 0;
            margin-top: 16px;
        }

        /* Add smooth transitions */
        .results-content, .results-header {
            transition: background-color 0.2s ease;
        }

        /* Hover effects */
        .results-column:hover {
            border-color: var(--button-hover);
        }

        .guidelines-textarea {
            height: 120px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .setting-help {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
        }

        /* Change indicator styles */
        .change-indicator {
            display: none;
        }

        .change-type {
            display: none;
        }

        .highlight-add {
            display: none;
        }

        .highlight-remove {
            display: none;
        }

        .highlight-modify {
            display: none;
        }

        .save-confirmation {
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            color: #10B981; /* Success green */
            font-size: 14px;
        }

        .save-confirmation.visible {
            display: flex;
        }

        .save-confirmation svg {
            stroke: #10B981;
        }

        /* Update primary button styles */
        .action-btn.primary {
            background-color: var(--text-color);  /* Dark in light mode, white in dark mode */
            color: var(--background-color);  /* Inverse text color */
            padding: 12px 24px;
            border-radius: 100px;  /* More rounded corners */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;  /* Full width like the image */
            transition: all 200ms ease;
        }

        .action-btn.primary:hover {
            background-color: var(--secondary-text);  /* Slightly lighter on hover */
        }

        .action-btn.primary svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Section title styles */
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 16px 0 8px 0;
        }

        .quality-report {
            padding: 24px;
            background: var(--surface-color);
            border-radius: 12px;
        }

        .score-summary {
            text-align: center;
            margin-bottom: 32px;
        }

        .score-display {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin: 24px 0;
            color: var(--text-color);
        }

        .score-display #qualityScore {
            font-size: 64px;
            font-weight: 600;
            line-height: 1;
        }

        .score-display::after {
            content: "/100";
            font-size: 24px;
            font-weight: 400;
            color: var(--secondary-text);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--surface-color);
            border: 4px solid;
        }

        .score-circle[data-score="85"] {
            border-color: #4CAF50;
        }

        .score-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
            color: var(--text-color);
        }

        .score-total {
            font-size: 16px;
            color: var(--secondary-text);
        }

        .score-badge {
            padding: 6px 12px;
            border-radius: 16px;
            background: #4CAF50;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }

        .criteria-section {
            margin: 32px 0;
        }

        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 16px;
        }

        .criteria-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .criterion-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-color);
        }

        .progress-bar {
            height: 8px;
            background: var(--button-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-button);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .analysis-section {
            display: grid;
            gap: 24px;
            margin: 32px 0;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .analysis-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Settings Modal Styles */
        .settings-modal {
            padding: 24px;
            background: var(--background-color);
            height: 100%;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-color);
            border-radius: 6px;
            margin-left: -8px;  /* Align with container padding */
        }

        .back-button:hover {
            background: var(--button-hover);
        }

        .back-button svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
            line-height: 1.4;
        }

        /* Update Dropdown Select Styles */
        .settings-select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: transparent; /* Remove background */
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 20px;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        .settings-select:hover {
            background-color: var(--button-hover);
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Remove background from select options */
        .settings-select option {
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Update Brand Guidelines Textarea */
        .settings-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: transparent;  /* Remove background */
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }

        .settings-textarea:hover {
            background-color: var(--button-hover);
        }

        .settings-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            background: transparent;  /* Keep transparent on focus */
        }

        /* Brand Guidelines Textarea */
        .brand-guidelines {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
        }

        .brand-guidelines h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .brand-guidelines h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            margin: 12px 0 4px;
        }

        .brand-guidelines p {
            font-size: 13px;
            line-height: 1.4;
            color: var(--secondary-text);
            margin-bottom: 8px;
        }

        .brand-guidelines ul {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .brand-guidelines li {
            font-size: 13px;
            line-height: 1.4;
            color: var(--secondary-text);
            margin-bottom: 4px;
            padding-left: 8px;
        }

        .brand-guidelines li::before {
            content: "•";
            color: var(--secondary-text);
            display: inline-block;
            width: 8px;
            margin-left: -8px;
        }

        /* Update button hover state */
        .action-btn:hover {
            background-color: var(--button-hover);
        }

        .action-btn:hover .btn-title {
            color: var(--text-color);
        }

        .action-btn:hover .btn-description {
            color: var(--secondary-text);
        }

        /* Update settings button container styles */
        .settings-button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: opacity 200ms ease;
            background-color: var(--background-color);
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .settings-button-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Update the apply button container */
        .apply-button-container {
            padding: 0 16px 72px; /* Add bottom padding to prevent overlap with footer */
            margin-top: auto;
        }

        /* Add styles for the container's inner div */
        .settings-button-container > div {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Add these styles to your existing CSS */
        .quality-results {
            padding: 16px;
        }

        .quality-score-card {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .score-display {
            font-size: 48px;
            font-weight: 600;
            margin: 24px 0;
            color: var(--text-color);
        }

        .quality-summary {
            color: var(--secondary-text);
            margin-bottom: 24px;
            font-size: 14px;
            line-height: 1.5;
        }

        .criteria-breakdown {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .criterion {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .progress-bar {
            height: 8px;
            background: var(--button-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .suggestions-section {
            margin-top: 24px;
        }

        .suggestions-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }

        #suggestionsList {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #suggestionsList li {
            position: relative;
            padding-left: 24px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--secondary-text);
        }

        #suggestionsList li::before {
            content: "•";
            position: absolute;
            left: 8px;
            color: var(--accent-color);
        }

        /* Add these styles */
        .results-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-color);
            border-radius: 6px;
        }

        .back-button:hover {
            background: var(--button-hover);
        }

        /* Add styles for text separators */
        .results-content hr {
            margin: 12px 0;
            border: none;
            border-top: 1px solid var(--border-subtle);
        }

        .results-content p {
            margin: 0;
            padding: 0;
            white-space: pre-wrap;
        }

        .settings-section-caption {
            font-size: 13px;
            color: var(--secondary-text);
            margin: 4px 0 12px 0;
            line-height: 1.4;
        }

        /* Add styles for premium indicator */
        .action-btn-end {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;  /* Push to right */
        }

        .premium-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-text);  /* White icon */
            background-color: var(--accent-color);  /* Purple background */
            width: 20px;
            height: 20px;
            border-radius: 4px;
            padding: 3px;
        }

        .premium-icon svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .premium-tag {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-color);
            background-color: var(--button-bg);
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            line-height: 1.4;
        }

        /* Update settings section header styles */
        .settings-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Add this new style for the coming-soon tag */
        .coming-soon-tag {
            font-size: 11px;
            font-weight: 600;
            color: var(--secondary-text);
            background-color: var(--button-bg);
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            line-height: 1.4;
        }

        /* Add these styles for the disabled state of action buttons */
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            background-color: var(--surface-color);
        }

        /* Add these styles for custom dropdowns */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background-color: var(--surface-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            line-height: 20px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 200ms ease;
        }

        .custom-select:hover {
            background-color: var(--button-hover);
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .custom-select-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--secondary-text);
        }

        .custom-select-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
        }

        /* Add these new styles for the dropdown options */
        .custom-select option {
            padding: 12px 16px;
            background-color: var(--surface-color);
            color: var(--text-color);
            border: none;
            font-size: 14px;
            line-height: 20px;
        }

        /* Unfortunately, styling select options is limited in most browsers. 
           For a fully custom dropdown, we'll need to create our own: */

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--surface-color);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .custom-select-option {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 200ms ease;
        }

        .custom-select-option:hover {
            background-color: var(--button-hover);
        }

        .custom-select-option.selected {
            background-color: var(--accent-color);
            color: white;
        }

        /* Add this style for the feedback link */
        .feedback-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary-text);
            font-size: 12px;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 200ms ease;
        }

        .feedback-link:hover {
            background-color: var(--button-hover);
            color: var(--text-color);
        }

        .feedback-link svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Add this style for the outlined button */
        .action-btn.outlined {
            background-color: transparent;
            border: 1.5px solid var(--text-color);
            color: var(--text-color);
            padding: 12px 24px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 200ms ease;
            margin-bottom: 8px;  /* Add space between buttons */
        }

        .action-btn.outlined:hover {
            background-color: var(--button-hover);
        }

        .action-btn.outlined svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Add styles for the container's inner div */
        .settings-button-container > div {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 4px;
        }
    </style>

    <!-- Add this in the head section -->
    <script>
    (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
    for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}var d={},e="get_group";for(h=0;h<j.length;h++)b(j[h]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement("script");e.type="text/javascript";e.async=!0;e.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===f.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";g=f.getElementsByTagName("script")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);
    </script>

    <!-- Initialize Mixpanel -->
    <script>
        // Initialize with your project token
        mixpanel.init('c82fa745ac9100cd811c50438d0353d3', {
            debug: true,
            track_pageview: true,
            persistence: 'localStorage'
        });

        // Add this line to verify initialization
        console.log('Mixpanel initialized:', mixpanel);

        // Track plugin load
        mixpanel.track('Plugin Loaded');
        console.log('Sent Plugin Loaded event');
    </script>
</head>
<body>
    <div class="container">
        <main>
            <textarea id="textEditor" class="textarea" placeholder="Select text in Figma or type here..."></textarea>
            <div class="section-title">Writing tools</div>
            <div class="action-panel">
                <button id="translateButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Translate</div>
                            <div class="btn-description">Convert text to different languages</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
                <button id="enhanceButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2L3 14h9l-1 8L21 10h-8L13 2z"></path>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Improve it</div>
                            <div class="btn-description">Improve writing quality and clarity</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
                <button id="shortenButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="6" cy="6" r="3"></circle>
                                <circle cx="6" cy="18" r="3"></circle>
                                <line x1="20" y1="4" x2="8.12" y2="15.88"></line>
                                <line x1="14.47" y1="14.48" x2="20" y2="20"></line>
                                <line x1="8.12" y1="8.12" x2="12" y2="12"></line>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <div class="btn-title">Shorten</div>
                            <div class="btn-description">Create a concise version of your text</div>
                        </div>
                    </div>
                    <div class="chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </button>
                <button id="qualityCheckButton" class="action-btn" disabled>
                    <div class="btn-content">
                        <div class="btn-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="btn-text">
                            <span class="btn-title">Quality Check</span>
                            <span class="btn-description">Analyze and score your copy</span>
                        </div>
                    </div>
                    <div class="action-btn-end">
                        <span class="coming-soon-tag">Coming Soon</span>
                        <div class="chevron">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>
            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <div class="loading-text">Processing...</div>
            </div>
            <div id="resultsView" class="results-view" style="display: none;">
                <div class="results-header">
                    <button id="backToEdit" class="back-button">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                            <path d="M10 12L6 8L10 4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                </button>
                    <h2>Results</h2>
                </div>
                
                <div class="results-container">
                    <div class="results-column">
                        <div class="results-column-header">
                            <h3>Original Text</h3>
                        </div>
                        <div class="results-content original">
                    <p id="originalText"></p>
                        </div>
                    </div>
                    <div class="results-column">
                        <div class="results-column-header">
                            <h3>Enhanced Text</h3>
                        </div>
                        <div class="results-content processed">
                    <p id="processedText"></p>
                        </div>
                    </div>
                </div>
                
                <div class="apply-button-container">
                    <button id="tryAgainButton" class="action-btn outlined">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Try Again
                    </button>
                    <button id="applyToFigma" class="action-btn primary">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                            <path d="M13.3332 4L5.99984 11.3333L2.6665 8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Apply to Figma
                    </button>
                </div>
            </div>
            <div id="qualityCheckResults" class="quality-results" style="display: none;">
                <div class="quality-score-card">
                    <div class="results-header">
                        <button id="backFromQualityCheck" class="back-button">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                                <path d="M10 12L6 8L10 4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <h2>Quality Check Result</h2>
                    </div>
                    <div class="score-display">
                        <span id="qualityScore">-</span>
                    </div>
                    <p id="qualitySummary" class="quality-summary"></p>
                    
                    <div class="criteria-breakdown">
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Clarity</span>
                                <span id="clarityScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="clarityBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Conciseness</span>
                                <span id="concisenessScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="concisenessBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Readability</span>
                                <span id="readabilityScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="readabilityBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Actionability</span>
                                <span id="actionabilityScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="actionabilityBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Tone & Consistency</span>
                                <span id="toneScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="toneBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="criterion">
                            <div class="criterion-header">
                                <span>Brand Fit</span>
                                <span id="brandFitScore">-%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="brandFitBar" class="progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="suggestions-section">
                        <h3>Suggestions for Improvement</h3>
                        <ul id="suggestionsList"></ul>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Add settings button container -->
        <div class="settings-button-container">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--secondary-text); font-size: 12px;">v0.3.7</span>
                <a href="https://tally.so/r/3yoGEB" target="_blank" class="feedback-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    Feedback
                </a>
                <button id="settingsButton" class="text-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal settings-modal">
        <div class="settings-header">
            <button class="back-button" id="closeSettings">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            <h2 class="settings-title">Settings & Preferences</h2>
            </div>

                <div class="settings-section">
            <div class="settings-section-title">Language</div>
            <div class="custom-select-wrapper">
                <select id="targetLanguageSelect" class="custom-select">
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="fr-ca">French (Canada)</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese</option>
                    <option value="nl">Dutch</option>
                    <option value="pl">Polish</option>
                    <option value="ru">Russian</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="zh">Chinese (Simplified)</option>
                </select>
                <div class="custom-select-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-header">
                <div class="settings-section-title">Brand Guidelines</div>
                <span class="premium-tag">Premium</span>
                </div>
            <p class="settings-section-caption">These guidelines will be applied to all text operations to maintain consistent brand voice.</p>
            <textarea id="brandGuidelinesInput" class="settings-textarea" placeholder="Enter your brand guidelines here..."></textarea>
            <div id="saveConfirmation" class="save-confirmation">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                    <path d="M3 8l3.5 3.5L13 4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Changes saved</span>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">Appearance</div>
            <div class="custom-select-wrapper">
                <select id="themeSelect" class="custom-select">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="system">System</option>
                </select>
                <div class="custom-select-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="settings-section" style="display: none;">
            <div class="settings-section-title">ABOUT</div>
            <div class="setting-item">
                <div class="setting-content">
                    <div class="setting-title" style="color: var(--secondary-text); font-size: 12px;">Version</div>
                    <div class="setting-description" style="color: var(--secondary-text); font-size: 12px;">0.3.7</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lottie script with load event listener -->
    <script>
        // UI Elements
        const textEditor = document.getElementById('textEditor');
        const translateButton = document.getElementById('translateButton');
        const enhanceButton = document.getElementById('enhanceButton');
        const shortenButton = document.getElementById('shortenButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeButton = document.getElementById('closeSettings');
        const targetLanguageSelect = document.getElementById('targetLanguageSelect');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsView = document.getElementById('resultsView');
        const backToEditButton = document.getElementById('backToEdit');
        const applyToFigmaButton = document.getElementById('applyToFigma');
        const themeSelect = document.getElementById('themeSelect');
        const qualityCheckButton = document.getElementById('qualityCheckButton');
        const qualityCheckResults = document.getElementById('qualityCheckResults');
        let currentProcessedTexts = [];
        let selectedTexts = new Map();

        // Initialize theme and request initial data
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            
            // Request initial data
            parent.postMessage({ pluginMessage: { type: 'get-selected-text' } }, '*');
            parent.postMessage({ pluginMessage: { type: 'get-language' } }, '*');
            parent.postMessage({ pluginMessage: { type: 'get-brand-guidelines' } }, '*');
        });

        // Show/hide functions
        function showResults() {
            textEditor.style.display = 'none';
            document.querySelector('.action-panel').style.display = 'none';
            document.querySelector('.section-title').style.display = 'none';
            document.querySelector('.settings-button-container').classList.add('hidden');
            resultsView.style.display = 'block';
            loadingIndicator.style.display = 'none';
        }

        function showEditor() {
            textEditor.style.display = 'block';
            document.querySelector('.action-panel').style.display = 'flex';
            document.querySelector('.section-title').style.display = 'block';
            document.querySelector('.settings-button-container').classList.remove('hidden');
            resultsView.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }

        // API call handler
        async function handleAPICall(endpoint, data) {
            console.log('[API Call] Starting:', endpoint);
            const startTime = performance.now();
            
            try {
                // Show loading state
                loadingIndicator.style.display = 'flex';
                textEditor.style.display = 'none';
                document.querySelector('.action-panel').style.display = 'none';

                // Process each text individually
                const processedTexts = [];
                const originalTexts = Array.from(selectedTexts.entries());
                
                for (const [id, text] of originalTexts) {
                    const response = await callAPI(endpoint, {
                        ...data,
                        text: text
                    });
                    
                    // Get the processed text based on endpoint
                    const processedText = endpoint === 'translate' ? response.translatedText :
                                        endpoint === 'shorten' ? response.shortenedText :
                                        response.enhancedText;
                    
                    processedTexts.push({
                        id: id,
                        text: processedText
                    });
                }
                
                // Track success with proper event names
                const eventName = endpoint === 'enhance' ? 'Enhancement' :
                                endpoint === 'translate' ? 'Translation' :
                                'Shorten';
                
                trackEvent(`${eventName} Completed`, {
                    textCount: processedTexts.length,
                    duration: performance.now() - startTime,
                    targetLanguage: data.targetLanguage || null
                });
                
                // Show results with the correct operation type
                showResults(
                    originalTexts.map(([_, text]) => text),
                    processedTexts,
                    endpoint
                );
                
                // Store for apply to Figma
                currentProcessedTexts = processedTexts;
                
                // Hide loading, show results
                loadingIndicator.style.display = 'none';
                resultsView.style.display = 'block';
                
            } catch (error) {
                // Track failure with proper event names
                const eventName = endpoint === 'enhance' ? 'Enhancement' :
                                endpoint === 'translate' ? 'Translation' :
                                'Shorten';
                
                trackEvent(`${eventName} Failed`, {
                    error: error.message,
                    textCount: selectedTexts.size,
                    duration: performance.now() - startTime,
                    targetLanguage: data.targetLanguage || null
                });
                
                console.error(`[${endpoint}] Error:`, error);
                loadingIndicator.style.display = 'none';
                textEditor.style.display = 'block';
                document.querySelector('.action-panel').style.display = 'flex';
                alert(`${endpoint} failed. Please try again.`);
            }
        }

        // Update button handlers to use the new handleAPICall function
        translateButton.addEventListener('click', async () => {
            console.log('[Action] Starting translation process');
            if (!textEditor.value.trim()) return;
            await handleAPICall('translate', {
                text: textEditor.value,
                targetLanguage: targetLanguageSelect.value
            });
        });

        enhanceButton.addEventListener('click', async () => {
            console.log('[Action] Starting enhancement process');
            if (!textEditor.value.trim()) return;
            await handleAPICall('enhance', {
                text: textEditor.value
            });
        });

        shortenButton.addEventListener('click', async () => {
            console.log('[Action] Starting shortening process');
            if (!textEditor.value.trim()) return;
            
            try {
                // Show loading state
                loadingIndicator.style.display = 'flex';
                textEditor.style.display = 'none';
                document.querySelector('.action-panel').style.display = 'none';
                
                const response = await callAPI('shorten', {
                    text: textEditor.value
                });
                
                console.log('[Shorten] Response:', response);
                
                // Update results view
                const originalTextDiv = document.getElementById('originalText');
                const processedTextDiv = document.getElementById('processedText');
                
                // Clear previous content
                originalTextDiv.innerHTML = '';
                processedTextDiv.innerHTML = '';
                
                // Add new content
                const originalP = document.createElement('p');
                originalP.textContent = textEditor.value;
                originalTextDiv.appendChild(originalP);
                
                const processedP = document.createElement('p');
                processedP.textContent = response.shortenedText;
                processedTextDiv.appendChild(processedP);
                
                // Update header
                document.querySelectorAll('.results-column-header h3')[1].textContent = 'Shortened Text';
                
                // Hide loading, show results
                loadingIndicator.style.display = 'none';
                resultsView.style.display = 'block';
                
                // Store for apply to Figma - use the stored selectedTexts Map
                currentProcessedTexts = Array.from(selectedTexts.keys()).map(id => ({
                    id: id,
                    text: response.shortenedText
                }));
                
            } catch (error) {
                console.error('[Shorten] Error:', error);
                loadingIndicator.style.display = 'none';
                textEditor.style.display = 'block';
                document.querySelector('.action-panel').style.display = 'flex';
                alert('Failed to shorten text. Please try again.');
            }
        });

        // Helper function for API calls
        async function callAPI(endpoint, data) {
            const startTime = performance.now();
            try {
                const response = await fetch(`https://copywriter-assistant-server.onrender.com/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'omit',
                    body: JSON.stringify(data)
                });
                
                const endTime = performance.now();
                console.log(`API Call Performance:
                    - Endpoint: ${endpoint}
                    - Total time: ${(endTime - startTime).toFixed(2)}ms
                    - Text length: ${data.text?.length || 0} chars`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`${endpoint} error:`, error);
                throw error;
            }
        }

        // Update the message handler to trigger button state update
        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            switch (msg.type) {
                case 'selected-text':
                    console.log('Received selected texts:', msg.texts);
                    selectedTexts.clear();
                    let combinedText = '';
                    
                    if (msg.texts && msg.texts.length > 0) {
                        msg.texts.forEach(item => {
                            selectedTexts.set(item.id, item.text);
                            combinedText += item.text + '\n\n';
                        });
                        
                        textEditor.value = combinedText.trim();
                        updateButtonStates(); // Update button states when text is received
                    } else {
                        textEditor.value = '';
                        updateButtonStates(); // Update button states when text is cleared
                    }
                    break;

                case 'set-brand-guidelines':
                    console.log('Received saved guidelines:', msg.guidelines);
                    if (msg.guidelines) {
                        brandGuidelinesInput.value = msg.guidelines;
                    }
                    break;

                case 'set-language':
                    console.log('Setting language to:', msg.language);
                    if (msg.language) {
                        targetLanguageSelect.value = msg.language;
                    }
                    break;

                case 'set-theme':
                    if (msg.theme) {
                        setTheme(msg.theme);
                        themeSelect.value = msg.theme;
                    }
                    break;

                case 'process-retry':
                    console.log('[Process Retry] Starting:', msg);
                    try {
                        // Call API with correct operation
                        const response = await callAPI(msg.operation, {
                            text: msg.texts[0].text,
                            targetLanguage: msg.params.targetLanguage
                        });
                        
                        // Get the correct response property based on operation
                        const processedText = msg.operation === 'translate' ? response.translatedText :
                                            msg.operation === 'shorten' ? response.shortenedText :
                                            response.enhancedText;
                        
                        // Show results with correct operation type
                        showResults(
                            [msg.texts[0].text], 
                            [{ id: msg.texts[0].id, text: processedText }],
                            msg.operation
                        );
                        
                        // Hide loading, show results
                        loadingIndicator.style.display = 'none';
                        resultsView.style.display = 'block';
                        
                    } catch (error) {
                        console.error('[Process Retry] Error:', error);
                        loadingIndicator.style.display = 'none';
                        alert('Failed to process text. Please try again.');
                    }
                    break;
            }
        };

        // Keep helper functions outside
        function setTheme(theme) {
            if (theme === 'system') {
                // Remove any explicit theme
                document.documentElement.removeAttribute('data-theme');
            } else {
                // Set explicit theme
                document.documentElement.setAttribute('data-theme', theme);
            }
        }

        function initializeTheme() {
            // Request saved theme from Figma
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'get-theme',
                    defaultTheme: 'dark' // Add default theme parameter
                }
            }, '*');
        }

        // Function to update button states
        function updateButtonStates() {
            const hasText = textEditor.value.trim().length > 0;
            translateButton.disabled = !hasText;
            enhanceButton.disabled = !hasText;
            shortenButton.disabled = !hasText;
        }

        // Add textarea event listeners
        textEditor.addEventListener('input', updateButtonStates);
        textEditor.addEventListener('change', updateButtonStates);

        // Settings modal functionality
        settingsButton.addEventListener('click', () => {
            trackEvent('Settings Opened');
            console.log('Sent Settings Opened event');  // Add debug log
            settingsModal.classList.add('visible');
        });

        closeButton.addEventListener('click', () => {
            settingsModal.classList.remove('visible');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('visible');
            }
        });

        // Brand guidelines save functionality
        const brandGuidelinesInput = document.getElementById('brandGuidelinesInput');
        const saveConfirmation = document.getElementById('saveConfirmation');

        let saveTimeout;

        brandGuidelinesInput.addEventListener('input', () => {
            // Clear any existing timeout
            clearTimeout(saveTimeout);
            
            // Set new timeout to save after user stops typing
            saveTimeout = setTimeout(async () => {
                try {
                    trackEvent('Brand Guidelines Updated', {
                        hasGuidelines: brandGuidelinesInput.value.length > 0,
                        guidelinesLength: brandGuidelinesInput.value.length
                    });
                    
                    // Send to parent (Figma)
            parent.postMessage({
                pluginMessage: {
                            type: 'save-brand-guidelines',
                            guidelines: brandGuidelinesInput.value 
                }
            }, '*');
                    
                    // Show save confirmation
                    saveConfirmation.classList.add('visible');
                    
                    // Hide confirmation after 2 seconds
                    setTimeout(() => {
                        saveConfirmation.classList.remove('visible');
                    }, 2000);
                    
            } catch (error) {
                    console.error('Error saving guidelines:', error);
                }
            }, 500); // Wait 500ms after last keystroke before saving
        });

        // Add apply to Figma handler
        applyToFigmaButton.addEventListener('click', () => {
            trackEvent('Apply to Figma', {
                textCount: currentProcessedTexts.length,
                totalCharacters: currentProcessedTexts.reduce((sum, text) => sum + text.text.length, 0)
            });
            
            // Send processed texts back to Figma
            parent.postMessage({
                pluginMessage: {
                    type: 'apply-text',
                    texts: currentProcessedTexts
                }
            }, '*');
            
            // Return to editor view
            showEditor();
        });

        // Add quality check button handler
        qualityCheckButton.addEventListener('click', async () => {
            if (!textEditor.value.trim()) return;
            
            try {
                // Show loading state
                loadingIndicator.style.display = 'block';
                textEditor.style.display = 'none';
                document.querySelector('.action-panel').style.display = 'none';
                document.querySelector('.section-title').style.display = 'none';
                
                // Get brand guidelines if they exist
                const brandGuidelines = document.getElementById('brandGuidelinesInput')?.value || '';
                
                // Call API
                const response = await callAPI('quality-check', {
                    text: textEditor.value,
                    brandGuidelines: brandGuidelines
                });
                
                // Update UI with results
                document.getElementById('qualityScore').textContent = response.score;
                document.getElementById('qualitySummary').textContent = response.summary;
                
                // Update individual scores and progress bars
                updateScore('clarity', response.criteria.clarity);
                updateScore('conciseness', response.criteria.conciseness);
                updateScore('readability', response.criteria.readability);
                updateScore('actionability', response.criteria.actionability);
                updateScore('tone', response.criteria.toneConsistency);
                updateScore('brandFit', response.criteria.brandFit);
                
                // Update suggestions
                const suggestionsList = document.getElementById('suggestionsList');
                suggestionsList.innerHTML = ''; // Clear existing suggestions
                response.suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    suggestionsList.appendChild(li);
                });
                
                // Show results
                loadingIndicator.style.display = 'none';
                resultsView.style.display = 'none';
                qualityCheckResults.style.display = 'block';
                document.querySelector('.settings-button-container').classList.add('hidden');
                
            } catch (error) {
                console.error('Quality check error:', error);
                loadingIndicator.style.display = 'none';
                showEditor();
                alert('Quality check failed. Please try again. ' + error.message);
            }
        });

        // Helper function to update scores and progress bars
        function updateScore(criterionName, score) {
            const scoreElement = document.getElementById(`${criterionName}Score`);
            const barElement = document.getElementById(`${criterionName}Bar`);
            
            if (scoreElement && barElement) {
                scoreElement.textContent = `${score}%`;
                barElement.style.width = `${score}%`;
            }
        }

        // Update showEditor function to hide quality check results
        function showEditor() {
            textEditor.style.display = 'block';
            document.querySelector('.action-panel').style.display = 'flex';
            document.querySelector('.section-title').style.display = 'block';
            document.querySelector('.settings-button-container').classList.remove('hidden');
            resultsView.style.display = 'none';
            qualityCheckResults.style.display = 'none';
            loadingIndicator.style.display = 'none';
        }

        // Add with other element selections at the top
        const backFromQualityCheck = document.getElementById('backFromQualityCheck');

        // Add the click handler
        backFromQualityCheck.addEventListener('click', () => {
            showEditor();
        });

        // Add theme change handler
        themeSelect.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            setTheme(selectedTheme);
            
            // Save theme preference to Figma storage
            parent.postMessage({
                pluginMessage: {
                    type: 'save-theme',
                    theme: selectedTheme
                }
            }, '*');
        });

        // Add this after the other event listeners in the script section
        targetLanguageSelect.addEventListener('change', (e) => {
            const selectedLanguage = e.target.value;
            console.log('Language changed to:', selectedLanguage);
            
            trackEvent('Language Changed', {
                language: selectedLanguage
            });
            
            // Save language preference to Figma storage
            parent.postMessage({
                pluginMessage: {
                    type: 'save-language',
                    language: selectedLanguage
                }
            }, '*');
        });

        // Add this to your existing script section
        function initializeCustomSelects() {
            document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
                const select = wrapper.querySelector('select');
                const customSelect = document.createElement('div');
                customSelect.className = 'custom-select';
                customSelect.textContent = select.options[select.selectedIndex].text;

                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'custom-select-options';

                // Create custom options
                Array.from(select.options).forEach((option, index) => {
                    const customOption = document.createElement('div');
                    customOption.className = 'custom-select-option';
                    if (index === select.selectedIndex) {
                        customOption.classList.add('selected');
                    }
                    customOption.textContent = option.text;
                    customOption.dataset.value = option.value;
                    
                    customOption.addEventListener('click', () => {
                        select.value = option.value;
                        customSelect.textContent = option.text;
                        optionsContainer.style.display = 'none';
                        
                        // Remove selected class from all options
                        optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        customOption.classList.add('selected');
                        
                        // Trigger change event on the original select
                        select.dispatchEvent(new Event('change'));
                    });
                    
                    optionsContainer.appendChild(customOption);
                });

                // Replace the original select with our custom elements
                select.style.display = 'none';
                wrapper.appendChild(customSelect);
                wrapper.appendChild(optionsContainer);

                // Toggle options display
                customSelect.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = optionsContainer.style.display === 'block';
                    // Close all other open dropdowns
                    document.querySelectorAll('.custom-select-options').forEach(container => {
                        container.style.display = 'none';
                    });
                    optionsContainer.style.display = isOpen ? 'none' : 'block';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    optionsContainer.style.display = 'none';
                });
            });
        }

        // Call this after the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeCustomSelects();
            // ... your other initialization code ...
        });

        // Add this to your existing script section, after the other button handlers
        const tryAgainButton = document.getElementById('tryAgainButton');

        tryAgainButton.addEventListener('click', () => {
            console.log('[Retry] Button clicked');
            
            // Get current operation from the second column header
            const headerText = document.querySelectorAll('.results-column-header h3')[1].textContent;
            console.log('[Retry] Header text:', headerText);
            
            // Fix the operation detection logic
            let currentOperation;
            switch (headerText) {
                case 'Translated Text':
                    currentOperation = 'translate';
                    break;
                case 'Shortened Text':
                    currentOperation = 'shorten';
                    break;
                case 'Enhanced Text':
                    currentOperation = 'enhance';
                    break;
                default:
                    console.error('[Retry] Unknown operation from header:', headerText);
                    return;
            }
            
            console.log('[Retry] Using operation:', currentOperation);
            
            // Show loading state
            loadingIndicator.style.display = 'flex';
            resultsView.style.display = 'none';
            
            // Send message to code.js
            parent.postMessage({
                pluginMessage: {
                    type: 'retry-text',
                    operation: currentOperation,
                    targetLanguage: targetLanguageSelect.value
                }
            }, '*');
        });

        // Update the back button handler
        backToEditButton.addEventListener('click', () => {
            console.log('[Back] Returning to editor view');
            
            // Hide results view
            resultsView.style.display = 'none';
            
            // Show editor and action panel
            textEditor.style.display = 'block';
            document.querySelector('.action-panel').style.display = 'flex';
            
            // Clear the results content
            document.getElementById('originalText').innerHTML = '';
            document.getElementById('processedText').innerHTML = '';
            
            // Reset any loading states
            loadingIndicator.style.display = 'none';
            
            // Update button states
            updateButtonStates();
        });

        // Update the showResults function to handle multiple texts properly
        function showResults(originalTexts, processedTexts, operation) {
            console.log('[Results] Showing results view');
            
            // Hide editor and action panel
            textEditor.style.display = 'none';
            document.querySelector('.action-panel').style.display = 'none';
            
            // Show results container
            resultsView.style.display = 'block';
            
            // Set the correct header text based on operation
            const processedHeader = document.querySelectorAll('.results-column-header h3')[1];
            switch (operation) {
                case 'translate':
                    processedHeader.textContent = 'Translated Text';
                    break;
                case 'shorten':
                    processedHeader.textContent = 'Shortened Text';
                    break;
                case 'enhance':
                    processedHeader.textContent = 'Enhanced Text';
                    break;
            }
            
            // Update the results content
            const originalTextDiv = document.getElementById('originalText');
            const processedTextDiv = document.getElementById('processedText');
            
            // Clear previous content
            originalTextDiv.innerHTML = '';
            processedTextDiv.innerHTML = '';
            
            // Add new content
            originalTexts.forEach((text, index) => {
                if (index > 0) {
                    originalTextDiv.appendChild(document.createElement('hr'));
                    processedTextDiv.appendChild(document.createElement('hr'));
                }
                
                const originalP = document.createElement('p');
                originalP.textContent = text;
                originalTextDiv.appendChild(originalP);
                
                const processedP = document.createElement('p');
                processedP.textContent = processedTexts[index].text;
                processedTextDiv.appendChild(processedP);
            });
        }
    </script>

    <script>
        // Replace the existing trackEvent function with this simplified version
        function trackEvent(eventName, properties = {}) {
            try {
                console.log(`Attempting to track event: ${eventName}`, properties);
                
                // Encode data for Mixpanel
                const data = {
                    event: eventName,
                    properties: {
                        ...properties,
                        token: 'c82fa745ac9100cd811c50438d0353d3',
                        time: Math.round(new Date().getTime() / 1000),
                        distinct_id: 'plugin_user' // Add a default distinct_id
                    }
                };

                // Base64 encode the data
                const encodedData = btoa(JSON.stringify(data));

                // Send to Mixpanel using fetch with correct headers
                fetch('https://api.mixpanel.com/track', {
                    method: 'POST',
                    headers: {
                        'Accept': 'text/plain',  // Change content-type to accept
                        'Content-Type': 'application/x-www-form-urlencoded'  // Use form encoding
                    },
                    body: `data=${encodedData}`  // Send as form data
                })
                .then(response => {
                    console.log(`Successfully sent ${eventName} event to Mixpanel:`, response);
                })
                .catch(error => {
                    console.error('Failed to send event to Mixpanel:', error);
                });

            } catch (error) {
                console.error('Error tracking event:', error);
            }
        }

        // Track settings and UI interactions
        settingsButton.addEventListener('click', () => {
            trackEvent('Settings Opened');
        });

        applyToFigmaButton.addEventListener('click', () => {
            trackEvent('Apply to Figma', {
                textCount: currentProcessedTexts.length
            });
        });

        // Track language changes
        targetLanguageSelect.addEventListener('change', (e) => {
            trackEvent('Language Changed', {
                language: e.target.value
            });
        });

        // Track theme changes
        themeSelect.addEventListener('change', (e) => {
            trackEvent('Theme Changed', {
                theme: e.target.value
            });
        });

        // Track when brand guidelines are updated
        brandGuidelinesInput.addEventListener('change', () => {
            trackEvent('Brand Guidelines Updated', {
                hasGuidelines: brandGuidelinesInput.value.length > 0
            });
        });
    </script>
</body>
</html>